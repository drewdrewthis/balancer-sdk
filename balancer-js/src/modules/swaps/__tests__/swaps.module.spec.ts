import dotenv from 'dotenv';
import { expect } from 'chai';

import {
    BalancerSdkConfig,
    BalancerSdkSorConfig,
    Network,
    BalancerSDK,
    Swaps,
} from '@/.';
import { mockPool, mockPoolDataService } from '@/test/lib/mockPool';
import { SwapType } from '../types';

dotenv.config();

const sorConfig: BalancerSdkSorConfig = {
    tokenPriceService: 'coingecko',
    poolDataService: mockPoolDataService,
    fetchOnChainBalances: false,
};

const sdkConfig: BalancerSdkConfig = {
    network: Network.KOVAN,
    rpcUrl: `https://kovan.infura.io/v3/${process.env.INFURA}`,
    sor: sorConfig,
};

describe('swaps module', () => {
    context('instantiation', () => {
        it('instantiate via module', async () => {
            const swaps = new Swaps(sdkConfig);
            await swaps.fetchPools();
            const pools = swaps.getPools();
            expect(pools).to.deep.eq([mockPool]);
        });

        it('instantiate via SDK', async () => {
            const balancer = new BalancerSDK(sdkConfig);
            await balancer.swaps.fetchPools();
            const pools = balancer.swaps.getPools();
            expect(pools).to.deep.eq([mockPool]);
        });
    });

    describe('#encodeBatchSwap', () => {
        it('should returns an ABI byte string', () => {
            const params = {
                kind: SwapType.SwapExactIn,
                swaps: [
                    {
                        poolId: '0x7320d680ca9bce8048a286f00a79a2c9f8dcd7b3000100000000000000000044',
                        assetInIndex: 0,
                        assetOutIndex: 1,
                        amount: '10000',
                        userData: '0x',
                    },
                    {
                        poolId: '0x36128d5436d2d70cab39c9af9cce146c38554ff0000100000000000000000008',
                        assetInIndex: 1,
                        assetOutIndex: 0,
                        amount: '0',
                        userData: '0x',
                    },
                ],
                assets: [
                    '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',
                    '0x9a71012B13CA4d3D0Cdc72A177DF3ef03b0E76A3',
                ],
                funds: {
                    fromInternalBalance: false,
                    recipient: '0x35f5a330FD2F8e521ebd259FA272bA8069590741',
                    sender: '0x35f5a330FD2F8e521ebd259FA272bA8069590741',
                    toInternalBalance: false,
                },
                limits: [0, 0], // No limits
                deadline: '999999999999999999', // Infinity
            };

            expect(Swaps.encodeBatchSwap(params)).to.equal(
                '0x945bcec900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000030000000000000000000000000035f5a330fd2f8e521ebd259fa272ba8069590741000000000000000000000000000000000000000000000000000000000000000000000000000000000000000035f5a330fd2f8e521ebd259fa272ba8069590741000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000de0b6b3a763ffff0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001007320d680ca9bce8048a286f00a79a2c9f8dcd7b300010000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000036128d5436d2d70cab39c9af9cce146c38554ff000010000000000000000000800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa841740000000000000000000000009a71012b13ca4d3d0cdc72a177df3ef03b0e76a3000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
            );
        });
    });

    describe('#encodeSimpleFlashSwap', () => {
        it('should returns an ABI byte string', () => {
            const params = {
                flashLoanAmount: '10000',
                poolIds: [
                    '0x7320d680ca9bce8048a286f00a79a2c9f8dcd7b3000100000000000000000044',
                    '0x36128d5436d2d70cab39c9af9cce146c38554ff0000100000000000000000008',
                ],
                assets: [
                    '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',
                    '0x9a71012B13CA4d3D0Cdc72A177DF3ef03b0E76A3',
                ],
                walletAddress: '0x35f5a330FD2F8e521ebd259FA272bA8069590741',
            };

            expect(Swaps.encodeSimpleFlashSwap(params)).to.equal(
                '0x945bcec900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000030000000000000000000000000035f5a330fd2f8e521ebd259fa272ba8069590741000000000000000000000000000000000000000000000000000000000000000000000000000000000000000035f5a330fd2f8e521ebd259fa272ba8069590741000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000de0b6b3a763ffff0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001007320d680ca9bce8048a286f00a79a2c9f8dcd7b300010000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000036128d5436d2d70cab39c9af9cce146c38554ff000010000000000000000000800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa841740000000000000000000000009a71012b13ca4d3d0cdc72a177df3ef03b0e76a3000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
            );
        });
    });
});
